openapi: 3.1.0
title: Quack API
info:
  version: 0.1.0
  title: Quack API
  description: Local-first DuckDB-backed API for file ingestion and SQL execution.
servers:
  - url: http://localhost:3001
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /files/upload:
    post:
      summary: Upload a file
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required:
                - file
      responses:
        '200':
          description: File uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUploadResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /files:
    get:
      summary: List uploaded files
      responses:
        '200':
          description: Array of files
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileListResponse'
  /tables:
    post:
      summary: Create table from uploaded file or append to existing table
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTableRequest'
      responses:
        '200':
          description: Table created or data appended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateTableResponse'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File or table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: List tables
      responses:
        '200':
          description: Array of tables
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableListResponse'
  /tables/{tableName}/schema:
    get:
      summary: Get table schema (column names and types)
      parameters:
        - name: tableName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Table schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableSchema'
        '400':
          description: Invalid table name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Table not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /tables/{tableName}/preview:
    get:
      summary: Preview table data
      parameters:
        - name: tableName
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            maximum: 1000
      responses:
        '200':
          description: Preview data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TablePreview'
        '400':
          description: Invalid table name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /query/execute:
    post:
      summary: Execute SQL query
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryExecuteRequest'
      responses:
        '200':
          description: Query executed
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    $ref: '#/components/schemas/QueryResult'
        '400':
          description: Syntax error or invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '408':
          description: Query timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /query/save-to-table:
    post:
      summary: Save query results to a new table using CREATE TABLE AS SELECT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveToTableRequest'
      responses:
        '200':
          description: Table created from query results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SaveToTableResponse'
        '400':
          description: Invalid input, syntax error, or table already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /notebooks:
    post:
      summary: Create notebook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNotebookRequest'
      responses:
        '200':
          description: Notebook created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notebook'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: List notebooks
      responses:
        '200':
          description: Array of notebooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  notebooks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notebook'
  /notebooks/{id}:
    get:
      summary: Get notebook by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Notebook details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookWithCells'
        '404':
          description: Notebook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update notebook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNotebookRequest'
      responses:
        '200':
          description: Notebook updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookWithCells'
        '404':
          description: Notebook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete notebook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Notebook deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Notebook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /notebooks/{id}/export:
    post:
      summary: Export notebook as markdown or .quackdb file
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '200':
          description: Export successful
          content:
            text/markdown:
              schema:
                type: string
              description: Markdown file when format=markdown
            application/octet-stream:
              schema:
                type: string
                format: binary
              description: .quackdb file when format=quackdb
        '400':
          description: Invalid input or format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Notebook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /notebooks/import:
    post:
      summary: Import notebook from .quackdb file
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required:
                - file
      responses:
        '200':
          description: Import successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotebookWithCells'
        '400':
          description: Invalid file or format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        timestamp:
          type: string
          format: date-time
    FileMetadata:
      type: object
      properties:
        id:
          type: string
        filename:
          type: string
        path:
          type: string
        uploaded_at:
          type: string
          format: date-time
    FileUploadResponse:
      type: object
      properties:
        file_id:
          type: string
      required:
        - file_id
    FileListResponse:
      type: object
      properties:
        files:
          type: array
          items:
            $ref: '#/components/schemas/FileMetadata'
    CreateTableRequest:
      type: object
      properties:
        file_id:
          type: string
        table_name:
          type: string
        mode:
          type: string
          enum: [create, append]
          default: create
          description: 'create to create a new table, append to append to existing table'
        target_table:
          type: string
          description: Required when mode is append, specifies the existing table to append to
      required:
        - file_id
        - table_name
    CreateTableResponse:
      type: object
      properties:
        table_id:
          type: string
        table_name:
          type: string
      required:
        - table_id
        - table_name
    TableMetadata:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        source_file_id:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
    TableListResponse:
      type: object
      properties:
        tables:
          type: array
          items:
            $ref: '#/components/schemas/TableMetadata'
    TableSchema:
      type: object
      properties:
        columns:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
      required:
        - columns
    TablePreview:
      type: object
      properties:
        columns:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
        rows:
          type: array
          items:
            type: array
            items: {}
        row_count:
          type: integer
      required:
        - columns
        - rows
        - row_count
    QueryExecuteRequest:
      type: object
      properties:
        sql:
          type: string
        limit:
          type: integer
          default: 1000
          maximum: 10000
        allowed_tables:
          type: array
          items:
            type: string
      required:
        - sql
    SaveToTableRequest:
      type: object
      properties:
        sql:
          type: string
          description: The SQL query whose results will be saved to the new table
        table_name:
          type: string
          description: Name for the new table (will be used in CREATE TABLE AS)
        description:
          type: string
          nullable: true
          description: Optional description that will be saved as a table comment
        allowed_tables:
          type: array
          items:
            type: string
          description: List of tables the query is allowed to access (for validation)
      required:
        - sql
        - table_name
    SaveToTableResponse:
      type: object
      properties:
        table_name:
          type: string
        row_count:
          type: integer
          description: Number of rows inserted into the new table
      required:
        - table_name
        - row_count
    QueryResultColumn:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
    QueryResult:
      type: object
      properties:
        columns:
          type: array
          items:
            $ref: '#/components/schemas/QueryResultColumn'
        rows:
          type: array
          items:
            type: array
            items: {}
        truncated:
          type: boolean
        rowCount:
          type: integer
      required:
        - columns
        - rows
        - truncated
        - rowCount
    Notebook:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        markdown:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - created_at
        - updated_at
    NotebookCell:
      type: object
      properties:
        id:
          type: string
        notebook_id:
          type: string
        cell_index:
          type: integer
        cell_type:
          type: string
          enum: [sql, markdown]
        sql_text:
          type: string
          nullable: true
        markdown_text:
          type: string
          nullable: true
        chart_config:
          type: string
          nullable: true
        selected_tables:
          type: array
          items:
            type: string
          nullable: true
        created_at:
          type: string
          format: date-time
      required:
        - id
        - notebook_id
        - cell_index
        - cell_type
        - created_at
    NotebookWithCells:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        markdown:
          type: string
          nullable: true
        cells:
          type: array
          items:
            $ref: '#/components/schemas/NotebookCell'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - cells
        - created_at
        - updated_at
    CreateNotebookRequest:
      type: object
      properties:
        name:
          type: string
        markdown:
          type: string
        cells:
          type: array
          items:
            type: object
            properties:
              cell_type:
                type: string
                enum: [sql, markdown]
              sql_text:
                type: string
              markdown_text:
                type: string
              chart_config:
                type: string
              selected_tables:
                type: array
                items:
                  type: string
      required:
        - name
    UpdateNotebookRequest:
      type: object
      properties:
        name:
          type: string
        markdown:
          type: string
        cells:
          type: array
          items:
            type: object
            properties:
              cell_type:
                type: string
                enum: [sql, markdown]
              sql_text:
                type: string
              markdown_text:
                type: string
              chart_config:
                type: string
              selected_tables:
                type: array
                items:
                  type: string
    ExportRequest:
      type: object
      properties:
        format:
          type: string
          enum: [markdown, quackdb]
          default: quackdb
        chartImages:
          type: object
          additionalProperties:
            type: string
          description: Map of cell ID to base64 PNG image data URL (for markdown export)
          nullable: true
      required:
        - format
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required:
        - error
