import { useEffect, useState } from 'react';
import { WorkspaceSidebar } from '@/components/WorkspaceSidebar';
import { WorkspaceToolbar } from '@/components/WorkspaceToolbar';
import { WorkspaceCellList } from '@/components/WorkspaceCellList';
import { WorkspacePreview } from '@/components/WorkspacePreview';
import { useCellManager } from '@/hooks/useCellManager';
import type { SavedQuery } from '@/hooks/useQueries';
import {
  useDocuments,
  useCreateDocument,
  useUpdateDocument,
  type CreateDocumentRequest,
} from '@/hooks/useDocuments';

export function WorkspacePage() {
  const [selectedQuery, setSelectedQuery] = useState<SavedQuery | undefined>();
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [currentDocumentId, setCurrentDocumentId] = useState<string | null>(null);
  const [currentDocumentName, setCurrentDocumentName] = useState('Untitled');
  const [isCreatingDoc, setIsCreatingDoc] = useState(false);
  const [mode, setMode] = useState<'edit' | 'preview'>('edit');
  const { cells, addCell, removeCell, updateCell, moveCellUp, moveCellDown, getCellIndex } =
    useCellManager();
  const documentsQuery = useDocuments();
  const createDocumentMutation = useCreateDocument();
  const updateDocumentMutation = useUpdateDocument();

  const handleLoadQuery = (query: SavedQuery) => {
    setSelectedQuery(query);
  };

  const handleAddCell = () => {
    addCell('sql');
  };

  const handleAddMarkdownCell = () => {
    addCell('markdown');
  };

  const handleSaveDocument = async () => {
    if (!currentDocumentId) return;
    const payload: CreateDocumentRequest = {
      name: currentDocumentName.trim() || 'Untitled',
      cells: cells.map((cell) => ({
        cell_type: cell.type,
        sql_text: cell.type === 'sql' ? cell.sql : undefined,
        markdown_text: cell.type === 'markdown' ? cell.markdown : undefined,
      })),
    };

    await updateDocumentMutation.mutateAsync({
      id: currentDocumentId,
      request: payload,
    });
  };

  useEffect(() => {
    if (!documentsQuery.isSuccess || isCreatingDoc || currentDocumentId) return;
    if (documentsQuery.data.length > 0) {
      const firstDoc = documentsQuery.data[0];
      if (firstDoc) {
        setCurrentDocumentId(firstDoc.id);
        setCurrentDocumentName(firstDoc.name);
      }
      return;
    }

    setIsCreatingDoc(true);
    createDocumentMutation
      .mutateAsync({
        name: 'Untitled',
        cells: cells.map((cell) => ({
          cell_type: cell.type,
          sql_text: cell.type === 'sql' ? cell.sql : undefined,
          markdown_text: cell.type === 'markdown' ? cell.markdown : undefined,
        })),
      })
      .then((doc) => {
        setCurrentDocumentId(doc.id);
        setCurrentDocumentName(doc.name);
      })
      .finally(() => setIsCreatingDoc(false));
  }, [documentsQuery.isSuccess, documentsQuery.data, isCreatingDoc, currentDocumentId]);

  return (
    <div className="h-full flex overflow-hidden">
      {isSidebarOpen && (
        <WorkspaceSidebar onLoadQuery={handleLoadQuery} onClose={() => setIsSidebarOpen(false)} />
      )}

      <div className="flex-1 flex flex-col min-w-0 overflow-hidden bg-quack-gold_bg">
        <WorkspaceToolbar
          documentName={currentDocumentName}
          documentId={currentDocumentId}
          isSidebarOpen={isSidebarOpen}
          mode={mode}
          isSaving={updateDocumentMutation.isPending}
          onDocumentNameChange={setCurrentDocumentName}
          onSave={handleSaveDocument}
          onModeChange={setMode}
          onToggleSidebar={() => setIsSidebarOpen(true)}
          onAddMarkdown={handleAddMarkdownCell}
          onAddSQL={handleAddCell}
        />

        {mode === 'preview' ? (
          <WorkspacePreview cells={cells} />
        ) : (
          <WorkspaceCellList
            cells={cells}
            selectedQuery={selectedQuery}
            getCellIndex={getCellIndex}
            onUpdateCell={updateCell}
            onRemoveCell={removeCell}
            onMoveCellUp={moveCellUp}
            onMoveCellDown={moveCellDown}
            onQuerySaved={setSelectedQuery}
          />
        )}
      </div>
    </div>
  );
}
